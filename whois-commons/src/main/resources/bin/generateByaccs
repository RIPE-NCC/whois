#!/bin/bash

set -e

gawk --version >/dev/null || exit 1

if [[ $(ps uxww | gawk "\$2 == $PPID && /sonar:sonar/" | wc -l) -gt 0 ]]; then
	ADDPATH='clover/'
fi
GENERATED_PATH=target/${ADDPATH}generated-sources/jflex/net/ripe/db/whois/common/generated

case $OSTYPE in
	darwin*)
		echo 'using byacc for OSX'
		binaryToRun='src/main/resources/bin/yacc.macosx'
		;;

	linux*)
		echo 'using byacc for LINUX'
		binaryToRun='src/main/resources/bin/yacc.linux'
		;;

	*)
		echo "ERROR: unknown OS '$OSTYPE', failing"
		exit 1
		;;
esac

echo 'AggrBndryParser src/main/resources/byacc/aggr_bndry.y
AggrMtdParser src/main/resources/byacc/aggr_mtd.y
ComponentsParser src/main/resources/byacc/components.y
ComponentsR6Parser src/main/resources/byacc/components_r6.y
DefaultParser src/main/resources/byacc/default.y
ExportParser src/main/resources/byacc/export.y
FilterParser src/main/resources/byacc/filter.y
IfaddrParser src/main/resources/byacc/ifaddr.y
ImportParser src/main/resources/byacc/import.y
InjectParser src/main/resources/byacc/inject.y
InjectR6Parser src/main/resources/byacc/inject_r6.y
InterfaceParser src/main/resources/byacc/interface.y
MpDefaultParser src/main/resources/byacc/mp_default.y
MpExportParser src/main/resources/byacc/mp_export.y
MpFilterParser src/main/resources/byacc/mp_filter.y
MpImportParser src/main/resources/byacc/mp_import.y
MpPeerParser src/main/resources/byacc/mp_peer.y
MpPeeringParser src/main/resources/byacc/mp_peering.y
PeerParser src/main/resources/byacc/peer.y
PeeringParser src/main/resources/byacc/peering.y
V6FilterParser src/main/resources/byacc/v6_filter.y' | while read GENERATED YACCDEF; do
    echo ${GENERATED};
	$binaryToRun -Jclass=${GENERATED} -Jnoconstruct -Jimplements='AttributeParser<Void>' -Jpackage='net.ripe.db.whois.common.generated' -J $YACCDEF
done

mkdir -p $GENERATED_PATH
mv *.java $GENERATED_PATH

echo "BYACC generation done, copied to $GENERATED_PATH"
